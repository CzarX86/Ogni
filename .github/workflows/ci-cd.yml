name: CI/CD Pipeline

on:
  push:
    branches: [ main, 001-core-ecommerce ]
  pull_request:
    branches: [ main, 001-core-ecommerce ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: ogni-project

jobs:
  # ==========================================
  # CI: Continuous Integration
  # ==========================================
  ci:
    name: 'CI Pipeline'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: 'ğŸ“¥ Checkout code'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 'âš™ï¸ Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 'ğŸ“¦ Install dependencies'
      run: npm ci

    - name: 'ğŸ” TypeScript type check'
      run: npm run type-check

    - name: 'ğŸ§¹ ESLint'
      run: npm run lint

    - name: 'ğŸ§ª Run tests'
      run: npm run test:ci
      env:
        CI: true

    - name: 'ğŸ“Š Upload test coverage'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false

    - name: 'ğŸ”’ Security audit'
      run: npm audit --audit-level moderate

    - name: 'ğŸ“± PWA validation'
      run: npm run pwa-validate

    - name: 'ğŸ“ Bundle size check'
      run: npm run build:analyze
      continue-on-error: true

    - name: 'ğŸ’¾ Cache build artifacts'
      uses: actions/cache@v3
      with:
        path: |
          dist/
          build/
        key: build-${{ github.sha }}

  # ==========================================
  # Staging Deploy
  # ==========================================
  deploy-staging:
    name: 'ğŸš€ Deploy to Staging'
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/001-core-ecommerce' && github.event_name == 'push'
    environment: staging
    timeout-minutes: 10

    steps:
    - name: 'ğŸ“¥ Checkout code'
      uses: actions/checkout@v4

    - name: 'âš™ï¸ Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 'ğŸ“¦ Install dependencies'
      run: npm ci

    - name: 'ğŸ”¨ Build for staging'
      run: npm run build:staging
      env:
        REACT_APP_ENVIRONMENT: staging
        REACT_APP_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}

    - name: 'ğŸ”¥ Deploy to Firebase (Staging)'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
        projectId: ${{ env.FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: './'

    - name: 'ğŸ“Š Performance check (Lighthouse)'
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://ogni-project.web.app
        configPath: .lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: 'ğŸ“¢ Notify deployment'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸš€ Staging deploy completed: ${{ github.event.head_commit.message }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_STAGING }}
      if: always()

  # ==========================================
  # Production Deploy (Manual Approval)
  # ==========================================
  deploy-production:
    name: 'ğŸš€ Deploy to Production'
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://ogni-project.web.app
    timeout-minutes: 15

    steps:
    - name: 'ğŸ“¥ Checkout code'
      uses: actions/checkout@v4

    - name: 'âš™ï¸ Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 'ğŸ“¦ Install dependencies'
      run: npm ci

    - name: 'ğŸ”¨ Build for production'
      run: npm run build:production
      env:
        REACT_APP_ENVIRONMENT: production
        REACT_APP_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}

    - name: 'ğŸ”¥ Deploy to Firebase (Production)'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
        projectId: ${{ env.FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: './'

    - name: 'ğŸ“Š Production performance check'
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://ogni-project.web.app
        configPath: .lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: 'ğŸ·ï¸ Create release'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## ğŸš€ Production Release

          **Commit**: ${{ github.sha }}
          **Author**: ${{ github.actor }}
          **Message**: ${{ github.event.head_commit.message }}

          ### Changes
          - Automated deployment from CI/CD pipeline
          - Performance validated with Lighthouse
          - Security checks passed

          ### Environment
          - Node.js ${{ env.NODE_VERSION }}
          - Firebase Hosting
          - PWA enabled
        draft: false
        prerelease: false

    - name: 'ğŸ“¢ Notify production deployment'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸ‰ Production deploy completed: ${{ github.event.head_commit.message }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_PRODUCTION }}
      if: always()

  # ==========================================
  # Manual Deploy (Workflow Dispatch)
  # ==========================================
  manual-deploy:
    name: 'ğŸš€ Manual Deploy'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment }}
    timeout-minutes: 15

    steps:
    - name: 'ğŸ“¥ Checkout code'
      uses: actions/checkout@v4

    - name: 'âš™ï¸ Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 'ğŸ“¦ Install dependencies'
      run: npm ci

    - name: 'ğŸ”¨ Build for ${{ github.event.inputs.environment }}'
      run: npm run build:${{ github.event.inputs.environment }}
      env:
        REACT_APP_ENVIRONMENT: ${{ github.event.inputs.environment }}
        REACT_APP_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}

    - name: 'ğŸ”§ Set Firebase service account'
      id: set-service-account
      run: |
        if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          echo "service_account=${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "service_account=${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}" >> $GITHUB_OUTPUT
        else
          echo "âŒ Invalid environment: ${{ github.event.inputs.environment }}"
          exit 1
        fi

    - name: 'ğŸ”¥ Deploy to Firebase (${{ github.event.inputs.environment }})'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ steps.set-service-account.outputs.service_account }}'
        projectId: ${{ env.FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: './'

    - name: 'ğŸ“¢ Notify manual deployment'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸ”§ Manual ${{ github.event.inputs.environment }} deploy completed by ${{ github.actor }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_MANUAL }}
      if: always()

  # ==========================================
  # Rollback Job
  # ==========================================
  rollback:
    name: 'ğŸ”„ Rollback'
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure' || needs.manual-deploy.result == 'failure')
    needs: [deploy-staging, deploy-production, manual-deploy]

    steps:
    - name: 'ğŸ“¥ Checkout previous version'
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.before }}

    - name: 'âš™ï¸ Setup Node.js'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 'ğŸ“¦ Install dependencies'
      run: npm ci

    - name: 'ğŸ”¨ Build rollback version'
      run: npm run build:production

    - name: 'ğŸ”¥ Rollback Firebase deployment'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
        projectId: ${{ env.FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: './'

    - name: 'ğŸ“¢ Notify rollback'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'âš ï¸ Automatic rollback executed due to deployment failure'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_ROLLBACK }}
      if: always()

  # ==========================================
  # Quality Gates
  # ==========================================
  quality-gate:
    name: 'âœ… Quality Gate'
    runs-on: ubuntu-latest
    needs: ci
    if: always()

    steps:
    - name: 'ğŸ¯ Check CI status'
      if: needs.ci.result != 'success'
      run: |
        echo "âŒ CI failed - blocking deployment"
        exit 1

    - name: 'ğŸ“Š Check test coverage'
      run: |
        if [ $(cat coverage/coverage-summary.json | jq '.total.lines.pct') -lt 80 ]; then
          echo "âŒ Test coverage below 80%"
          exit 1
        fi
        echo "âœ… Test coverage: $(cat coverage/coverage-summary.json | jq '.total.lines.pct')%"

    - name: 'ğŸ”’ Check security'
      run: |
        if npm audit --audit-level high | grep -q "vulnerabilities"; then
          echo "âŒ High security vulnerabilities found"
          exit 1
        fi
        echo "âœ… No high security vulnerabilities"

    - name: 'ğŸ“± Check PWA compliance'
      run: |
        if ! npm run pwa-validate; then
          echo "âŒ PWA validation failed"
          exit 1
        fi
        echo "âœ… PWA validation passed"